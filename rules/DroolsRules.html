<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        
            <meta name="description" content="Tutorial to walk you through the process of creating a HTML5 game and integrating it with the Phune Gaming platform." />
        

        
            <title>Server-side rules in Drools | Phune Gaming</title>
        

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/app.css" />

        <!-- Custom JS -->
        <script src="/bower_components/modernizr/modernizr.js"></script>
    </head>
    <body>
        <nav class="top-bar docs-bar">
    <ul class="title-area">
        <li class="name">
            <h1><a href="http://www.phune.com/">Phune Gaming</a></h1>
        </li>
    </ul>
    <section class="top-bar-section">
        <ul class="right">
            <li class="divider"></li>
            <li class="has-form">
                <a href="https://github.com/phune-gaming/pg-docs" class="small button">View source</a>
            </li>
        </ul>
    </section>
</nav>


        <header>
    <div class="row">
        <div class="small-12 columns">
            <h1>Phune Gaming docs</h1>
        </div>
    </div>
</header>


        <main class="row">
            <nav class="large-3 medium-4 columns">
                <div class="sidebar show-for-small-only">
                    <ul class="side-nav">
    <li class="heading">Guide</li>

    
        <li><a href="/">Getting started</a></li>
    

    
        <li><a href="/best-practices.html">Best practices</a></li>
    

    
        <li><a href="/install.html">Install Phune Gaming</a></li>
    

    
        <li><a href="/sdk-js.html">JavaScript SDK</a></li>
    

    
        <li><a href="/server-rules.html">Server-side rules</a></li>
    

    <li class="divider"></li>

    <li class="heading">Miscellaneous</li>

    
        <li><a href="/definitions.html">Definitions</a></li>
    

    <li class="divider"></li>

    <li class="heading">Game example</li>

    <li><a href="https://github.com/phune-gaming/pg-tic-tac-toe" target="_blank">Tic-Tac-Toe source code</a></li>
</ul>

                </div>
                <div class="sidebar show-for-medium-up" data-magellan-expedition="fixed">
                    <ul class="side-nav">
    <li class="heading">Guide</li>

    
        <li><a href="/">Getting started</a></li>
    

    
        <li><a href="/best-practices.html">Best practices</a></li>
    

    
        <li><a href="/install.html">Install Phune Gaming</a></li>
    

    
        <li><a href="/sdk-js.html">JavaScript SDK</a></li>
    

    
        <li><a href="/server-rules.html">Server-side rules</a></li>
    

    <li class="divider"></li>

    <li class="heading">Miscellaneous</li>

    
        <li><a href="/definitions.html">Definitions</a></li>
    

    <li class="divider"></li>

    <li class="heading">Game example</li>

    <li><a href="https://github.com/phune-gaming/pg-tic-tac-toe" target="_blank">Tic-Tac-Toe source code</a></li>
</ul>

                </div>
            </nav>
            <section class="large-9 medium-8 columns">
                <h2>Server-side rules in Drools</h2>
                

                <h3>DroolsRules.drl</h3>
<div class="highlight"><pre><code class="text language-text" data-lang="text">package com.presenttechnologies.phunegaming.games.example

import com.presenttechnologies.phunegaming.core.entities.Match;
import com.presenttechnologies.phunegaming.core.entities.Match.Status;
import com.presenttechnologies.phunegaming.core.entities.Player;
import com.presenttechnologies.phunegaming.core.entities.dto.PlayerMoveDTO;
import com.presenttechnologies.phunegaming.core.entities.dto.PlayerMoveDTO.EvaluationResultType;
import com.presenttechnologies.phunegaming.core.entities.events.EventTypePK.Action;
import com.presenttechnologies.phunegaming.core.entities.events.AccomplishmentEvent;;


/*The moves are sent to the server in JSON format. In order to be interpreted by
Drools they must be converted to an object defined inside Drools. For instance:*/

declare Move
    posX : int
    posY : int
end

/*
Using Drools a rule to setup the match must be created. The initial match status
must be Status.CREATED and after all the necessary setup is performed it should
be changed to Status.PLAYING. The lastMoveDate in the match object should be
set to null.
*/
rule &quot;match setup&quot;
    when 
        $m : Match(game.id == [The game id of the match], status == Status.CREATED, lastMoveDate == null);
    then
        $m.setStatus(Status.PLAYING);
        update($m);
        // setup other rules
        //[other facts related to the game]
end

/*In Drools, new queries to obtain the nextPlayerId and nextMoveId must be 
created. The platform bridge between Java and Drools expect vars 
$lastPlayerMoveDTO and $nextPlayer to exist, please do not change their names.*/

query &quot;findLastPlayerMoveDTO&quot;
   $lastPlayerMoveDTO : PlayerMoveDTO($lowMoveId : moveId); 
   not PlayerMoveDTO(moveId &gt; $lowMoveId);
end

query &quot;findNextPlayer&quot;
   Match($players : players);
   PlayerMoveDTO($playerId : playerId, $lowMoveId : moveId); 
   not PlayerMoveDTO(moveId &gt; $lowMoveId);
   $nextPlayer : Player(id!=$playerId) from $players; 
end


/*The class name, Move in this example, should always be sent by the clients in 
the className variable so Drools can instantiate the correct object. This 
approach removes the need to create and compile Java POJOs for each move.

The code snippet below demonstrates a possible implementation of the rules for: 
a valid move, an invalid move, and an ending move containing the winner info.*/

rule &quot;invalid move&quot;
// execute first
salience 10
    when
        $match : Match(status == Status.PLAYING);
        $pm : PlayerMoveDTO(evaluationResultType==null);
        //[other game-related facts to fire this rule]
    then
        // error
        $pm.setEvaluationResultType(EvaluationResultType.FAILED_VALIDATION);
        $pm.setEvaluationContent(&quot;A string to inform the failed reason&quot;);
        // drop the invalid facts from working memory
        retract(/*[Some invalid fact]*/);
        //...
     end

rule &quot;valid move&quot;
when
        $match : Match(status == Status.PLAYING);
        $pm : PlayerMoveDTO(evaluationResultType==null);
        // other game-related facts to fire this rule
    then
        modify($pm){
            setEvaluationResultType(EvaluationResultType.SUCCESS);
        }
        // modify or insert new facts in a valid move
     end

rule &quot;winner move&quot;
when
        $match : Match(status == Status.PLAYING);
        $pm : PlayerMoveDTO(evaluationResultType==null);
        // other game-related facts to fire this rule
    then
        $pm.setWinnerPlayerId($playerId);
        $pm.setEvaluationContent(&quot;String of the result of winning&quot;);
        $pm.setEvaluationResultType(EvaluationResultType.MATCH_END_WINNER);
     end
</code></pre></div>
            </section>
        </main>

        <footer>
    <div class="row">
        <div class="small-12 columns">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="http://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a>
            <p>Copyright 2014 Present Technologies.<br />
            This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.</p>
        </div>
    </div>
</footer>


        <script src="/bower_components/jquery/dist/jquery.min.js"></script>
        <script src="/bower_components/foundation/js/foundation.min.js"></script>
        <script src="/js/app.js"></script>
    </body>
</html>
